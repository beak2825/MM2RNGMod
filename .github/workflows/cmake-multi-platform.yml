name: Build MM2RNGMod

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install basic tools
      run: |
        sudo apt update
        sudo apt install -y python3-pip wget
        pip3 install pyelftools mmh lz4

    - name: Install devkitPro pacman
      run: |
        wget https://apt.devkitpro.org/install-devkitpro-pacman
        chmod +x install-devkitpro-pacman
        sudo ./install-devkitpro-pacman

    - name: Install Switch toolchain (correct package names 2025)
      run: |
        sudo dkp-pacman -Syu --noconfirm
        sudo dkp-pacman -S --needed --noconfirm \
          devkitA64 libnx switch-cmake switch-libcxx switch-tools

        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "/opt/devkitpro/tools/bin" >> $GITHUB_PATH
        echo "/opt/devkitpro/devkitA64/bin" >> $GITHUB_PATH

    - name: Verify clang is available
      run: |
        which clang
        clang --version

    - name: Run LibHakkun setup scripts (already in sys/ because of submodule)
      run: |
        cd sys/tools
        python3 setup_libcxx_prepackaged.py
        python3 setup_sail.py

    - name: Configure CMake
      run: |
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -GNinja

    - name: Build
      run: |
        cd build
        ninja

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MM2RNGMod-build
        path: |
          build/*.nsp
          build/*.ips
          build/*.pchtxt
          build/exefs/**
        retention-days: 30
