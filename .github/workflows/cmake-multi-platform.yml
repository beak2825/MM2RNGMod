name: Build MM2RNGMod (Switch)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install base dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip git wget curl sudo
        pip3 install pyelftools mmh lz4  # LibHakkun requirements

    - name: Set up devkitPro pacman
      run: |
        wget https://apt.devkitpro.org/install-devkitpro-pacman
        chmod +x install-devkitpro-pacman
        sudo ./install-devkitpro-pacman
        sudo dkp-pacman -Syu --noconfirm  # Sync and update pacman

    - name: Install Switch toolchain packages
      run: |
        # Install core packages individually (avoids group prompt)
        sudo dkp-pacman -S --needed --noconfirm devkitA64 libnx switch-cmake switch-libcxx-16 switch-tools
        # Set environment variables
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "$DEVKITPRO/tools/bin" >> $GITHUB_PATH
        echo "$DEVKITPRO/devkitA64/bin" >> $GITHUB_PATH
        # Load env
        source "$DEVKITPRO/corevars.sh"
        # Debug: Verify installs
        which clang || echo "Clang not in PATH"
        clang --version || echo "Clang version check failed"

    - name: Clone and set up LibHakkun
      run: |
        git clone https://github.com/fruityloops1/LibHakkun.git
        cd LibHakkun
        python3 tools/setup_libcxx_prepackaged.py
        python3 tools/setup_sail.py
        # Symlink sys to MM2RNGMod root for toolchain access
        ln -sf $(pwd)/sys ..

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -GNinja -DCMAKE_TOOLCHAIN_FILE=../sys/cmake/toolchain.cmake

    - name: Build
      run: |
        cd build
        ninja

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MM2RNGMod-build
        path: |
          build/*.nsp
          build/exefs/**
          build/*.ips
          build/*.pchtxt
        retention-days: 30
