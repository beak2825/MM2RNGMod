name: Build MM2RNGMod

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: devkitpro/devkitarm:latest

    # THIS IS THE ONLY CHANGE YOU NEED
    env:
      DEVKITPRO: /opt/devkitpro
      DEVKITA64: /opt/devkitpro/devkitA64
      DEVKITARM: /opt/devkitpro/devkitARM

    steps:
    - name: Fix PATH for devkitA64 tools
      run: |
        echo "PATH=/opt/devkitpro/devkitA64/bin:/opt/devkitpro/tools/bin:$PATH" >> $GITHUB_ENV

    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Python dependencies
      run: |
        apt update
        apt install -y python3-pip
        pip3 install --break-system-packages pyelftools mmh lz4

    - name: Verify tools work
      run: |
        clang --version
        aarch64-none-elf-gcc --version
        ninja --version
        cmake --version
        echo "DEVKITA64 = $DEVKITA64"

    - name: Setup LibHakkun
      run: |
        cd sys/tools
        python3 setup_libcxx_prepackaged.py
        python3 setup_sail.py

    - name: Build
      run: |
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -GNinja -DCMAKE_TOOLCHAIN_FILE=../sys/cmake/toolchain.cmake
        ninja

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MM2RNGMod-exefs
        path: build/exefs/**
