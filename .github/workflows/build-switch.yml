name: Build MM2RNGMod

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: devkitpro/devkitarm:latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup devkitPro environment   # â† THIS IS THE ONLY FIX
      run: |
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "DEVKITA64=/opt/devkitpro/devkitA64" >> $GITHUB_ENV
        echo "/opt/devkitpro/devkitA64/bin" >> $GITHUB_PATH
        echo "/opt/devkitpro/tools/bin" >> $GITHUB_PATH

    - name: Install Python deps
      run: |
        apt update
        apt install -y python3-pip
        pip3 install --break-system-packages pyelftools mmh lz4

    - name: Verify tools (now works!)
      run: |
        clang --version
        ninja --version
        cmake --version
        echo "DEVKITA64 = $DEVKITA64"

    - name: Setup LibHakkun
      run: |
        cd sys/tools
        python3 setup_libcxx_prepackaged.py
        python3 setup_sail.py

    - name: Build
      run: |
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -GNinja -DCMAKE_TOOLCHAIN_FILE=../sys/cmake/toolchain.cmake
        ninja
        echo "Build complete! Listing output:"
        ls -la

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MM2RNGMod
        path: |
          build/exefs/**
          build/*.nsp
          build/*.ips
