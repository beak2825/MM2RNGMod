name: LibHakkun Build (Switch)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip git wget ninja-build cmake build-essential
        # Run LibHakkun scripts (downloads LLVM 19-based stdlib)
        python3 sys/tools/setup_libcxx_prepackaged.py
        python3 sys/tools/setup_sail.py
        # Install matching LLVM 19 (fixes reader/producer mismatch)
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 19
        sudo apt-get install -y clang-19 llvm-19 lld-19
        # Python deps
        python3 -m pip install --break-system-packages pyelftools mmh lz4

    - name: Verify tools
      run: |
        clang-19 --version  # Should show LLVM 19
        ninja --version
        cmake --version

    - name: Configure and Build
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=clang-19 \
          -DCMAKE_CXX_COMPILER=clang++-19 \
          -DCMAKE_ASM_COMPILER=clang-19 \
          -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld-19" \
          -DCMAKE_MODULE_LINKER_FLAGS="-fuse-ld=lld-19" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fuse-ld=lld-19" \
          -DCMAKE_TOOLCHAIN_FILE=sys/cmake/toolchain.cmake
        cmake --build build --parallel $(nproc)
        # Debug: List outputs
        find build -name "*.nso" -o -name "*.nsp" -o -name "exefs" | head -10 || ls -la build/

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MM2RNGMod-build
        path: |
          build/*.nso
          build/*.nsp
          build/*.ips
          build/*.pchtxt
          build/exefs/**
        retention-days: 30
        if-no-files-found: warn
